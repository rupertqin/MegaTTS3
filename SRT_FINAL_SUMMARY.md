# SRT 字幕功能最终版本

## 核心改进

### 1. 引号处理

- ✅ 引号不作为分割点
- ✅ 引号内容保持完整
- ✅ 引号不计入字符数限制

### 2. 智能断句

- ✅ 优先在"的"、"地"、"得"等助词后断开
- ✅ 避免把词语从中间切断
- ✅ 确保分割后不会产生过短的片段

### 3. 字符计数

- ✅ 标点符号不计入字符数
- ✅ 每行 10-15 个实际字符（不含标点）
- ✅ 更准确的长度控制

## 分句规则

### 优先级断点

1. **第一优先级**：的、地、得、了、着、过
2. **第二优先级**：是、在、和、与、或、及、把、被
3. **最后选择**：强制在 15 字处断开

### 评分机制

```python
score = 0

# 下一个字符是优先字符
if next_char in ['的', '地', '得', '了', '着', '过']:
    score += 15
elif next_char in ['是', '在', '和', '与', '或', '及', '把', '被']:
    score += 8

# 越接近目标长度越好
score -= abs(current_length - 15)

# 剩余部分长度评分
if remaining >= 10:
    score += 5  # 剩余部分足够长
else:
    score -= (10 - remaining) * 3  # 剩余部分太短，降低分数
```

## 实际效果

### 示例 1：基本分句

```
原文：最近有个传闻在网上闹得沸沸扬扬，说康熙皇帝可能是个汉人。

结果：
1. 最近有个传闻在网上闹得沸沸扬扬 (15字)
2. 说康熙皇帝可能是个汉人 (11字)
```

### 示例 2：智能断句

```
原文：反过来审判男性基于风险控制的生物策略。

之前（错误）：
1. 反过来审判男性基于风险控制的生 (15字)
2. 物策略 (3字)  ❌ 词语被切断

现在（正确）：
1. 反过来审判男性基于风险控制 (13字)
2. 的生物策略 (5字)  ✅ 在"的"前断开
```

### 示例 3：引号处理

```
原文：现在的舆论场有一个很大的误区，就是试图把母亲这种基于确定性的"天然高投入"，包装成一个不可反驳的"道德制高点"。

结果：
1. 现在的舆论场有一个很大的误区 (14字，不含标点)
2. 就是试图把母亲这种基于确定性的 (15字)
3. "天然高投入" (5字，引号不计数)
4. 包装成一个不可反驳的"道德制高点" (15字)
```

## 技术细节

### 字符计数函数

```python
def count_chars_without_punctuation(text):
    """计算文本字符数，不包括标点符号"""
    clean_text = re.sub(r'[，。！？；：、,\.!?;:"""''「」『』（）\(\)\s]', '', text)
    return len(clean_text)
```

### 分割流程

```
1. 按标点分割（不包括引号）
   ↓
2. 合并过短片段（< 10字）
   ↓
3. 智能分割超长片段（> 15字）
   - 计算所有可能的分割点
   - 评分选择最佳位置
   - 优先在助词后断开
   ↓
4. 最后合并过短片段
   ↓
5. 生成 SRT 文件
```

## 使用方法

### 生成音频和字幕

```bash
./gen/gen.sh
```

### 仅生成字幕

```bash
./gen/gen.sh srt
```

### Python 调用

```python
from incremental_tts_generator import split_subtitle_text

text = "你的文本内容"
lines = split_subtitle_text(text, max_chars=15, min_chars=10)

for i, line in enumerate(lines, 1):
    print(f"{i}. {line}")
```

## 参数调整

在 `incremental_tts_generator.py` 中：

```python
# 调用时可以自定义参数
subtitle_lines = split_subtitle_text(
    text,
    max_chars=15,  # 最大字符数（不含标点）
    min_chars=10   # 最小字符数（不含标点）
)
```

### 推荐参数

- **手机屏幕**：max_chars=12, min_chars=8
- **电脑屏幕**：max_chars=15, min_chars=10（默认）
- **大屏幕**：max_chars=18, min_chars=12

## 优势总结

1. **更自然的断句**

   - 在语法自然的位置断开
   - 不会把词语从中间切断
   - 符合中文语言习惯

2. **更准确的长度控制**

   - 标点符号不计入字符数
   - 引号不影响长度判断
   - 实际显示长度更一致

3. **更好的阅读体验**

   - 每行 10-15 个实际字符
   - 避免过短字幕一闪而过
   - 避免过长字幕难以阅读

4. **智能化处理**
   - 自动选择最佳断点
   - 平衡各部分长度
   - 减少人工调整需求

## 测试验证

所有功能已通过测试：

- ✅ 基本分句功能
- ✅ 智能断点选择
- ✅ 引号完整性保持
- ✅ 字符计数准确性
- ✅ 长度限制有效性

## 下一步

功能已完全实现并优化，可以立即使用：

```bash
cd gen
./gen.sh
```

生成的 SRT 文件将自动应用所有优化规则！
