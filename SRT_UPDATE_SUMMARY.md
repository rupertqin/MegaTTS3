# SRT 字幕功能优化总结

## 优化内容

### 1. 智能分句逻辑

**之前的问题：**

- 单独的标点符号会被分成一行
- 过短的句子（少于 10 字）显示时间太短
- 末尾标点符号影响视觉效果

**现在的解决方案：**

- ✅ 按标点符号分割文本
- ✅ 自动合并少于 10 字的片段
- ✅ 自动去除末尾标点符号
- ✅ 每行 10-15 字，阅读舒适

### 2. 分句规则

```python
def split_subtitle_text(text, max_chars=15, min_chars=10):
    """
    - 按标点符号分割（，。！？；：、等）
    - 每行不超过 15 个字符
    - 少于 10 个字的片段自动合并
    - 去除末尾标点符号
    """
```

### 3. 处理流程

```
原文
  ↓
按标点分割
  ↓
合并过短片段（< 10字）
  ↓
分割超长片段（> 15字）
  ↓
再次合并过短片段
  ↓
去除末尾标点
  ↓
生成 SRT
```

## 实际效果对比

### 优化前

```srt
1
00:00:00,000 --> 00:00:02,560
最近有个传闻在网上闹得沸沸扬扬

2
00:00:02,560 --> 00:00:02,600
，

3
00:00:02,600 --> 00:00:05,120
说康熙皇帝可能是个汉人。
```

❌ 问题：单独的逗号、末尾有标点

### 优化后

```srt
1
00:00:00,000 --> 00:00:02,560
最近有个传闻在网上闹得沸沸扬扬

2
00:00:02,560 --> 00:00:05,120
说康熙皇帝可能是个汉人
```

✅ 改进：无单独标点、无末尾标点、长度合适

## 测试结果

```bash
$ python tests/test_srt_generation.py
============================================================
SRT 字幕生成功能测试
============================================================
测试字幕文本分割...

原文: 最近有个传闻在网上闹得沸沸扬扬，说康熙皇帝可能是个汉人。
分割结果 (2 行):
  ✅ 第1行 (15字): 最近有个传闻在网上闹得沸沸扬扬
  ✅ 第2行 (11字): 说康熙皇帝可能是个汉人

原文: 这是第一句，这是第二句，这是第三句。
分割结果 (1 行):
  ✅ 第1行 (15字): 这是第一句这是第二句这是第三句

✅ 所有测试通过!
```

## 使用方法

### 1. 生成音频和字幕

```bash
./gen/gen.sh
```

### 2. 仅生成字幕

```bash
./gen/gen.sh srt
```

### 3. 合并音频和生成字幕

```bash
./gen/gen.sh merge
```

## 参数调整

如需调整分句规则，编辑 `incremental_tts_generator.py`：

```python
# 在生成 SRT 时调用
subtitle_lines = split_subtitle_text(
    entry['text'],
    max_chars=15,  # 最大字符数
    min_chars=10   # 最小字符数
)
```

### 推荐参数

- **手机屏幕**: max_chars=12, min_chars=8
- **电脑屏幕**: max_chars=15, min_chars=10（默认）
- **大屏幕**: max_chars=18, min_chars=12

## 文件更新

### 修改的文件

- `incremental_tts_generator.py` - 更新 `split_subtitle_text()` 函数
- `tests/test_srt_generation.py` - 更新测试用例

### 新增的文件

- `gen/SRT_SUBTITLE_RULES.md` - 分句规则说明
- `SRT_UPDATE_SUMMARY.md` - 本文档

## 优势总结

1. **视觉效果更好**

   - 无单独标点符号
   - 无末尾标点
   - 每行长度适中

2. **阅读体验更佳**

   - 10-15 字的长度最适合快速阅读
   - 避免过短字幕一闪而过
   - 自然断句符合语言习惯

3. **逻辑更简洁**

   - 代码更清晰易懂
   - 减少特殊情况处理
   - 更容易维护和调整

4. **完全自动化**
   - 无需手动调整
   - 智能合并和分割
   - 与音频完美同步

## 下一步

功能已完全实现并测试通过，可以立即使用：

```bash
cd gen
./gen.sh
```

生成的 SRT 文件将自动应用新的分句规则！
